<% hide_message_form ||= false %>
<% heading ||= nil %>
<% heading ||= "Start a conversation about this below!" if messages.empty? %>
<% @message ||= Conversations::Message.new(conversation: conversation) unless hide_message_form %>
<div class="element-box form-base no-margin">
  <div class="full-chat-w">
    <div class="full-chat-i">
      <div class="full-chat-middle">
        <div class="chat-content-w chat-style-scrolling" data-model="Conversation" data-id="<%= conversation.id %>">
          <div class="chat-content" data-collection="messages">
            <% if heading.present? %>
              <div class="chat-date-separator" style="margin-top: 0;">
                <span><%= heading %></span>
              </div>
            <% end %>
            <% messages.each_with_index do |message, index| %>

              <% timestamp = time_ago_in_words(message.created_at) + " ago" %>
              <% name = message.user.name %>
              <% avatar = capture do %>
                <img alt="" src="<%= membership_profile_photo_url(message.membership) %>" title="<%= message.membership.name %>">
              <% end %>

              <% if message.user == messages[index + 1]&.user %>
                <% name = nil %>
                <% unless message.created_at < messages[index + 1].created_at - 5.minutes %>
                  <% avatar = nil %>
                  <% timestamp = nil %>
                <% end %>
              <% end %>

              <% body = capture do %>
                <div class="chat-message-content-w">
                  <div class="chat-message-content"><%= trix_sanitize(message.body) %></div>
                </div>
              <% end %>

              <% message.body = '{sample message}' unless message.body.present? %>

              <% emoji = 'emoji' if strip_tags(message.body).only_emoji? %>

              <% if message.user == current_user %>
                <div class="chat-message self <%= emoji %> <%= 'no-avatar' unless avatar %> <%= 'no-timestamp' unless timestamp %>">
                  <%= body %>
                  <% if timestamp || avatar %>
                    <div class="chat-message-date">
                      <% if avatar %>
                        <strong><%= name %></strong>
                      <% end %>
                      <%= timestamp %>
                    </div>
                    <div class="chat-message-avatar">
                      <%= avatar || capture do %>
                        <div style="height: 40px; width: 10px;"></div>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              <% else %>
                <div class="chat-message <%= emoji %>">
                  <%= body %>
                  <% if timestamp || avatar %>
                    <div class="chat-message-avatar"><%= avatar %></div>
                    <div class="chat-message-date">
                      <% if avatar %>
                        <strong><%= name %></strong>
                      <% end %>
                      <%= timestamp %>
                    </div>
                  <% end %>
                </div>
              <% end %>
            <% end %>
          </div>
        </div>
        <% unless hide_message_form %>
        <div class="chat-controls">
          <%= form_with(model: [:account, conversation, @message], local: true, id: 'new-message-form', class: 'action-cable-result', data: {scroll: "[data-model='Conversation']"}) do |form| %>
            <%= render 'shared/forms/errors', form: form %>
            <div class="chat-input" style="position: relative; padding-top: 20px;">
              <%= render 'shared/fields/trix_editor', form: form, method: :body, options: {placeholder: 'Type your message here ...', style: 'min-height: inherit;', autofocus: true, data: {enter: 'submit'}}, other_options: {hide_label: true} %>
              <%= form.submit t('.buttons.create'), class: "btn btn-primary btn-sm" %>
            </div>
            <div class="chat-input-extra">
              <div class="chat-btn">
              </div>
            </div>
          <% end %>
        </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
